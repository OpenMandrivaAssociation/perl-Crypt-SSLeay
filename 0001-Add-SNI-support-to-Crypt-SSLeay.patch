From 5d86904e699837b21a1edd4a2d0408ab080fb314 Mon Sep 17 00:00:00 2001
From: Ben Morrow <ben@morrow.me.uk>
Date: Mon, 4 Oct 2010 17:08:43 +0100
Subject: [PATCH] Add SNI support to Crypt::SSLeay.

---
 SSLeay.xs      |    9 +++++++++
 lib/Net/SSL.pm |    4 ++++
 2 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/SSLeay.xs b/SSLeay.xs
index 9df9f58..34248e4 100644
--- a/SSLeay.xs
+++ b/SSLeay.xs
@@ -392,6 +392,15 @@ SSL_get_cipher(ssl)
         OUTPUT:
            RETVAL        
 
+#if OPENSSL_VERSION_NUMBER >= 0x0090806fL && !defined(OPENSSL_NO_TLSEXT)
+
+void
+SSL_set_tlsext_host_name(ssl, name)
+        SSL *ssl
+        const char *name
+
+#endif
+
 MODULE = Crypt::SSLeay        PACKAGE = Crypt::SSLeay::X509        PREFIX = X509_
 
 void
diff --git a/lib/Net/SSL.pm b/lib/Net/SSL.pm
index d9c0360..59f5f07 100644
--- a/lib/Net/SSL.pm
+++ b/lib/Net/SSL.pm
@@ -120,6 +120,10 @@ sub connect {
     my $new_arg = *$self->{ssl_new_arg};
     $arg->{SSL_Debug} = $debug;
 
+    # setup SNI if available
+    $ssl->can("set_tlsext_host_name") and
+        $ssl->set_tlsext_host_name(*$self->{ssl_peer_addr});
+
     eval {
         local $SIG{ALRM} = sub { $self->die_with_error("SSL connect timeout") };
         # timeout / 2 because we have 3 possible connects here
-- 
1.7.1.1

